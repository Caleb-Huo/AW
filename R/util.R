aw.fisher.stat <- function(pstat, n) {
    index = match(n, awFisherData[["nList"]])
#    if(!is.na(index)) {
#        quant = awFisherData[[method]][index,]
#    } else {
        ### smooth estimation over n
        numN = NCOL(awFisherData$original)
        quant = rep(0, numN)
        for(i in 1:numN) {
            f = splinefun(c(1, awFisherData[["nList"]]), c(awFisherData[["logPTarget"]][i], awFisherData$original[,i]))
            quant[i] = f(n)
        }
#    }

    ##### Estimating ###########
    f = splinefun(c(0,quant), c(0,awFisherData[["logPTarget"]]), method="monoH.FC")
    exp(-f(pstat))
}


preDefList = exp(log(501)*(1:50)/50)-1
uncondTopDist <- function(stat, n, which) {
    estimates = pvalueTop(A=preDefList, n=n, m=which)
    f = splinefun(c(0,preDefList), c(0,estimates), method="monoH.FC")
    f(stat)
}

intFunc <- function(p,A,n,m) {
    pchisq(A+2*m*log(p), 2*m, lower.tail=F)*dbeta(p, m+1, n-m)
}
pvalueTop <- Vectorize(function(A,n,m) {
                pLim = exp(-A/(2*m))
                -log(integrate(intFunc, lower=pLim,upper=1,A = A, n=n,m=m, stop.on.error=F,rel.tol=1e-3)$value
                        + pbeta(pLim, m+1, n-m))}
             )

######################
####  Data
######################

awFisherData = list(logPTarget=-log(c(0.99, 0.95,0.9,0.8,0.7,0.5,0.3,1e-1,1e-2,1e-3,1e-5,1e-7,1e-10, 1e-15, 1e-25, 1e-80,1e-200)),
          original=matrix(c(0.0991299,0.2307506,0.3616958,0.4908891,0.6012938,0.7007693,0.8010211,0.8852742,0.9674844,
                              1.113856,1.304995,1.612286,2.274926,3.816328,6.379592,10.03372,15.8871,28.39492,50.09994,107.3815,
                            0.2532749,0.4589056,0.6426983,0.7975563,0.9350853,1.056027,1.165338,1.267054,1.36635,1.545324,
                              1.810291,2.243907,3.162265,5.079755,8.110184,12.3064,18.90731,32.46575,55.64708,115.5134,
                            0.3785702,0.6240129,0.8244336,0.9922922,1.142877,1.27297,1.397758,1.508944,1.621461,1.83459,
                              2.140719,2.646127,3.666674,5.782382,9.040087,13.49952,20.3788,34.47629,58.35517,119.4172,
                            0.5911318,0.8747565,1.10027,1.286399,1.455918,1.606457,1.752032,1.885532,2.017578,2.267131,
                              2.638745,3.232473,4.391949,6.732669,10.29312,15.05824,22.34432,37.068,61.78113,124.354,
                            0.7887108,1.100477,1.346518,1.550477,1.736986,1.905264,2.067322,2.21877,2.36439,2.644688,
                              3.053511,3.714803,4.978453,7.494532,11.26784,16.27226,23.84434,38.99281,64.31994,128.0403,
                            1.21693,1.582346,1.865415,2.105853,2.32561,2.519655,2.706602,2.884535,3.060112,3.404064,3.876032,
                              4.631569,6.076903,8.897185,13.01535,18.40227,26.42127,42.35352,68.65255,134.2008,
                            1.812172,2.224871,2.54456,2.815906,3.066485,3.299503,3.521331,3.727825,3.931819,4.326293,
                              4.869171,5.727013,7.353057,10.47594,14.96737,20.72703,29.19919,45.86845,73.2044,140.5048,
                            3.006446,3.498343,3.882972,4.202215,4.504013,4.763724,5.026574,5.270521,5.514426,5.981952,6.619728,
                              7.632539,9.526118,13.06491,18.04471,24.38708,33.53347,51.32331,80.00293,149.9905,
                            5.412572,5.978331,6.421937,6.818137,7.178373,7.489069,7.806217,8.101734,8.40125,8.966433,
                              9.724746,10.9367,13.20626,17.32554,22.98528,30.12292,40.1709,59.49315,90.07466,163.6995,
                            7.771121,8.360937,8.862098,9.283587,9.705136,10.04135,10.41136,10.72468,11.07541,11.6783,
                              12.54049,13.87575,16.40208,20.96055,27.11554,34.78738,45.51271,65.95685,97.89573,174.1557,
                            12.44521,13.09599,13.6526,14.10011,14.54778,14.986,15.30801,15.77355,16.13772,16.79953,17.82213,
                              19.38547,22.27196,27.42194,34.3746,42.84719,54.5786,76.72491,110.749,191.039,
                            17.09525,17.75282,18.3716,18.88985,19.37994,19.78108,20.14133,20.75287,21.01495,21.71198,
                              22.83626,24.6096,27.71989,33.2676,40.9529,49.94472,62.55643,85.9504,121.8311,205.3097,
                            24.03921,24.68517,25.40527,25.95085,26.45911,26.87557,27.39865,27.67894,28.19278,29.0289,
                              30.23832,32.32301,35.47315,41.61328,49.97596,59.59598,73.60026,98.42317,136.9592,224.2329,
                            35.56544,36.24341,36.8793,37.71307,38.04985,39.3861,38.91839,39.42456,39.97605,40.79525,42.19192,
                              44.34679,47.92825,54.43455,64.27763,74.33595,90.52811,116.6218,161.774,248.6012,
                            58.59329,59.29901,59.84986,60.87042,61.81504,61.85231,61.88179,62.51328,63.15607,64.2352,65.50203,
                              68.01901,72.74197,79.66,89.91935,101.7426,118.9691,150.7868,192.5185,292.6912,
                            185.1815,186.014,186.6892,187.0414,187.5587,187.9156,189.0134,189.5565,190.0352,192.4073,
                              192.6559,194.5913,201.7345,209.2415,223.7879,239.5384,258.8478,297.156,352.8421,474.5017,
                            461.2872,462.3472,462.4968,462.8381,463.8254,463.8606,464.7668,464.4796,465.2994,465.9452,
                              467.9054,471.0704,474.8733,484.9073,498.1799,512.5592,541.8607,585.8783,651.6489,798.9819), ncol=17),            
          nList = c(2:10,12,15,20,30,50,80,120,180,300,500,1000),
          totalN = 100000)
